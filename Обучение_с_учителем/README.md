# Описание проекта
Интернет-магазин «В один клик» продаёт разные товары: для детей, для дома, мелкую бытовую технику, косметику и даже продукты. Отчёт магазина за прошлый период показал, что активность покупателей начала снижаться. Привлекать новых клиентов уже не так эффективно: о магазине и так знает большая часть целевой аудитории. Возможный выход — удерживать активность постоянных клиентов. Сделать это можно с помощью персонализированных предложений.
## Задача проекта 
Разработать решение, которое позволит увеличить покупательскую активность пользователей, путем персонализированных предложений:


 1. Нужно построить модель, которая предскажет вероятность снижения покупательской активности клиента в следующие три месяца.
 2. В исследование нужно включить дополнительные данные финансового департамента о прибыльности клиента: какой доход каждый покупатель приносил компании за последние три месяца.
 3. Используя данные модели и данные о прибыльности клиентов, нужно выделить сегменты покупателей и разработать для них персонализированные предложения.

    
Разработать решение, которое позволит увеличить покупательскую активность пользователей, путем персонализированных предложений:


 1. Нужно построить модель, которая предскажет вероятность снижения покупательской активности клиента в следующие три месяца.
 2. В исследование нужно включить дополнительные данные финансового департамента о прибыльности клиента: какой доход каждый покупатель приносил компании за последние три месяца.
 3. Используя данные модели и данные о прибыльности клиентов, нужно выделить сегменты покупателей и разработать для них персонализированные предложения.

## Описание данных
Данные для работы находятся в нескольких таблицах.
 1. [`market_file.csv`](https://code.s3.yandex.net/datasets/market_file.csv) - Таблица, которая содержит данные о поведении покупателя на сайте, о коммуникациях с покупателем и его продуктовом поведении.
    - `id` — номер покупателя в корпоративной базе данных.
    - `Покупательская активность` — рассчитанный класс покупательской активности (целевой признак): «снизилась» или «прежний уровень».
    - `Тип сервиса` — уровень сервиса, например «премиум» и «стандарт».
    - `Разрешить сообщать` — информация о том, можно ли присылать покупателю дополнительные предложения о товаре. Согласие на это даёт покупатель.
    - `Маркет_актив_6_мес` — среднемесячное значение маркетинговых коммуникаций компании, которое приходилось на покупателя за последние 6 месяцев. Это значение показывает, какое число рассылок, звонков, показов рекламы и прочего приходилось на клиента.
    - `Маркет_актив_тек_мес` — количество маркетинговых коммуникаций в текущем месяце.
    - `Длительность` — значение, которое показывает, сколько дней прошло с момента регистрации покупателя на сайте.
    - `Акционные_покупки` — среднемесячная доля покупок по акции от общего числа покупок за последние 6 месяцев.
    - `Популярная_категория` — самая популярная категория товаров у покупателя за последние 6 месяцев.
    - `Средний_просмотр_категорий_за_визит` — показывает, сколько в среднем категорий покупатель просмотрел за визит в течение последнего месяца.
    - `Неоплаченные_продукты_штук_квартал` — общее число неоплаченных товаров в корзине за последние 3 месяца.
    - `Ошибка_сервиса` — число сбоев, которые коснулись покупателя во время посещения сайта.
    - `Страниц_за_визит` — среднее количество страниц, которые просмотрел покупатель за один визит на сайт за последние 3 месяца.
    
    
 2. [`market_money.csv`](https://code.s3.yandex.net/datasets/market_money.csv) - Таблица с данными о выручке, которую получает магазин с покупателя, то есть сколько покупатель всего потратил за период взаимодействия с сайтом.
    - `id` — номер покупателя в корпоративной базе данных.
    - `Период` — название периода, во время которого зафиксирована выручка. Например, 'текущий_месяц' или 'предыдущий_месяц'.
    - `Выручка` — сумма выручки за период.
    
    
 3. [`market_time.csv`](https://code.s3.yandex.net/datasets/market_time.csv) - Таблица с данными о времени (в минутах), которое покупатель провёл на сайте в течение периода.
    - `id` — номер покупателя в корпоративной базе данных.
    - `Период` — название периода, во время которого зафиксировано общее время.
    - `минут` — значение времени, проведённого на сайте, в минутах.
    
    
 4. [`money.csv`](https://code.s3.yandex.net/datasets/money.csv) - Таблица с данными о среднемесячной прибыли покупателя за последние 3 месяца: какую прибыль получает магазин от продаж каждому покупателю.
    - `id` — номер покупателя в корпоративной базе данных.
    - `Прибыль` — значение прибыли.
   
## Вывод по проекту
### EDA

В ходе работы в качесте исходных данных было получено 4 датасета.

Данные были проверены на дубликаты и пропуски. Был один неявный дубликат в поле `Тип сервиса`, который был приведен к общему типу. Пропусков в датасетах не было. Типы данных соответствовали. 

В ходе статистического был выявлен выброс в поле `market_money_df['Выручка']`, при проведении корреляционного анализа было принято решение удалить данный выброс. Также обнаружеy дисбаланс классов целевого признака.

Для проведения корреляционного анализа данные объеденены в единный датафрейм `data`. Также перед проведение корреляционого анализа были отсеяны пользователи не покупавшие товары в течение последних 3 месяцев.  

В ходе корреляционного анализа были проверены количетсвенные признаки на мультиколлинеарность (не обнаружено) с помощью функции `pd.DataFrame.corr`. Также проведена оценка корреляции всех признаков с помошью библиотеки `phik`. 

Можно выделить следующие признаки, которые влияют на активность пользователя:
 - `'Страниц_за_визит'` - $0.75$
 - `'Предыдущий_месяц_минут'` - $0.69$
 - `'текущий_месяц_минут'` - $0.58$
 - `'Маркет_актив_6_мес'` - $0.55$
 - `'Средний_просмотр_категорий_за_визит'` - $0.54$
 - `'Неоплаченные_продукты_штук_квартал'` - $0.51$
 - `'выручка_препредыдущий_месяц'` - $0.50$
 - `'Популярная категория'` - $0.30$
 - `'выручка_предыдущий_месяц'` - $0.23$
 - `'выручка_текущий_месяц'` - $0.2$
 
### Выбор моделей

Для решения основной задачи прогнозирования снижения активности пользователей были использованы 4 модели:
 - `KNeighborsClassifier()`
 - `DecisionTreeClassifier()`
 - `LogisticRegression()`
 - `SVC()`
 
Поиск оптимальных гиперпараметров осуществлялся с помощью инструмента `RandonSearchCV`, сами модели были помещены в `pipelin'ы`, с соответствующими наборами гиперпараметров.

Для оценки качества модели будем использовать следующие метрики:
 - $ROC-AUC$, т.к. мы имеем дело с дисбалансом классов в целевом признаке на треировочной выборке. Данная метрика поможет оценить описательную способность модели.
 - $F_\beta-score$, т.к. нам необходимо точно определить пользователей, чья активность снижается, следовательно важнее метрика $recall$
 
Былдо принято решение оценить работу моделей с учетом отбора лучших признаков, так и с учетом всех признаков:

 - В ходе поиска гиперпараметров без отбора признаков была выбрана модель `KNeighborsClassifier`
 - При использовании метолда отбора признаков в результате поиска гиперпараметров была выбрана модель `KNeighborsClassifier`


В результате было принято решение предложить обе модели, т.к.:
1. Если **критично** важно не пропускать пользователей склонных к снижению активности, то с этим лучше справится модель LogisticRegression c отбором признаков за счет более высокой метрики `fbeta_score`. Ниже приведены параметры модели:
 
>`LogisticRegression(C=0.7143340896097039, class_weight='balanced',
                   l1_ratio=0.6508884729488529, penalty='l1', random_state=42,
                   solver='saga')`
                   
> `SelectKBest(k=12, score_func=mutual_info_classif)`


    
 2. Если необходимо соблюдать баланс между отбором пользователей со снижающейся активностью и расходом на удержание пользователей, то лучше себя показывает `KNeighborsClassifier`, без отбора признаков. Однако данная модель допускает больше пропусков объекта класса $1$ чем `LogisticRegression`. Ниже параметры модели:
 
> `KNeighborsClassifier(metric='cityblock', n_neighbors=83)`


Сравнение метрик моделей: 

|Метрика	|Logistic Regression	|KNeighborsClassifier
|:-:|:-:|:-:|
|**ROC-AUC (train)**	|$0.900$	|$0.902$
|**ROC-AUC (test)**	|$0.918$	|$0.918$
|**F-beta (test)**	|$0.837$	|$0.774$
|**F1-score (test)**	|$0.844$	|$0.872$


Исходя из обзора обеих моделей можно сделать следующие выводы:
 - На целевой признак (покупательская активность) большее влияние оказывают признаки показывающие как много времени пользователь проводит на сайте:
     - сколько времени он проводит на сайте,
     - какое количество категорий его интересует за визит,
     - как много страниц он пролистывает в интересующих категориях,
     - акционные предложения
     
 - Меньше влияют:
     - параметры выручки
     - стаж пользователя с момента регистрации
     - конкретные категории товаров 
     - ошибки сервиса
     
То есть можно предположить, что падение онлайн активности пользователя и его концентрация ТОЛЬКО на акционных товарах могут свидетельствовать о снижении его интереса к сервису.

Можно рекомендовать следующее:
 - при обнаружении падения активности пользователя, стоит персонализировать и предложить ему смежные с интересующими его категориями и товарами ценами,
 - также стоит акцентировать внимание на ежемесячной аналитике данных об активности пользователей: если признаки "текущий месяц минут" и "предыдущий месяц минут" снижаются - прямые признаки, снижения активности пользователя. Данные признаки отобраны для обоих моделях и оказывают большее влияние на целевую переменную.

### Сегментация клиентов

Мною был выбран сегмент пользователей, чья доля акционных покупок превышает $60\%$. Данных пользователей мы выделяли на этапе статистического анализа, их доля составляет $12.85\%$
 - данный сегмент должен представлять высокий интерес для заказчика, т.к. содержит в себе около $10\%$ всего оборота сервиса за отчетный период.
 - при этом данный сегмент содержит более $25\%$ пользователей, чья активность снизилась за отчетный период.
 - наибольше популярностью пользуются следующие категории: `Товары для детей` и `Косметика и аксесуары`.
 
Можно дать следующие рекомендации для сопровождения данного сегмента:
 - персонализированные предложения из смежных категорий, например:
     - `Товары для детей` $\rightarrow$ `Домашний текстиль`, `Кухонная посуда`
     - `Косметика и аксесуары` $\rightarrow$ `Техника для красоты и здоровья`, `Мелкая бытовая техника и электроника`
     
 - акцентировать внимание на маркетинговом сопровождении пользователей - настроить мониторинг маркетинговой активности:
     - еще на этапе корреляционного анализа мы установили, что признак `'Маркет_актив_6_мес'` имеет коэффициент $\phi_k = 0.55$, и имеет весомый вклад в определение класса в обеих моделях.

